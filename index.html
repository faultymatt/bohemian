// === Unlock & init (robust) ===
const unlock = document.getElementById('unlock');
let audioReady = false;
let building = null; // init中のPromiseを共有

async function initAudio() {
  // ここはあなたの既存の initAudio と同等の内容に合わせてOK
  // （osc/ampEnv/filter の構築、osc.start()、setMix() など）
  // 例：await Tone.start(); ... のように書いてある想定
}

async function startOnce() {
  if (audioReady) {
    // すでに初期化済みならoverlayだけ消す
    unlock.style.display = 'none';
    return;
  }
  if (!building) {
    building = (async () => {
      try {
        // ブラウザのポリシーに確実に乗る：ユーザー操作内でTone.start()
        await Tone.start();
        await initAudio();
        audioReady = true;
      } catch (e) {
        console.error('Audio init failed:', e);
        // 失敗してもoverlayは消しておく（キーで再試行できるように）
      } finally {
        unlock.style.display = 'none';
      }
    })();
  }
  await building; // 同時多発を防ぐ
}

// ボタン：押したら必ず消す + 初期化トライ
unlock.addEventListener('click', startOnce);

// キー入力でも確実に初期化（QWERTYマッピングの前で呼ぶ）
window.addEventListener('keydown', async (e) => {
  // どのキーでも初期化を試す（最初の1回だけ実行）
  if (!audioReady) await startOnce();
});
