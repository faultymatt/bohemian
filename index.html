<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bohemian – Keys-First Wavetable (A/B + Custom + Serum Pitch)</title>
<link rel="icon" href="/favicon.ico">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
  html,body{height:100%;margin:0;background:#050510;color:#f3f4f6;font-family:'Orbitron',sans-serif}
  h1{font-size:28px;margin:0 0 8px;text-align:center;background:linear-gradient(90deg,#8b5cf6,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .wrap{max-width:1100px;margin:0 auto;padding:32px}
  .card{background:rgba(15,20,35,.85);border:1px solid #1f2937;border-radius:20px;padding:20px;box-shadow:0 20px 40px rgba(0,0,0,.5);backdrop-filter:blur(10px);margin-bottom:16px}
  .row{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;align-items:center}
  label{font-size:13px;color:#9ca3af}
  input[type=range]{accent-color:#8b5cf6}
  select{background:#0a0f1f;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:8px}
  .num{display:inline-block;min-width:48px;text-align:right}
  .sliders{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;margin-top:8px}
  .sliders label{display:flex;flex-direction:column;align-items:center;font-size:10px;color:#94a3b8}
  .btn{border:0;border-radius:12px;padding:10px 18px;font-size:14px;cursor:pointer;font-family:'Orbitron';transition:.2s}
  .btn.ghost{background:transparent;color:#9ca3af;border:1px solid #374151}
  .btn.ghost:hover{color:#fff;border-color:#8b5cf6}
  .hint{color:#6b7280;font-size:12px;text-align:center;margin-top:6px}
  .kbd{font-family:ui-monospace,monospace;background:#0a0f1f;border:1px solid #1e2637;border-radius:6px;padding:2px 6px}
</style>
<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
</head>
<body>
<div class="wrap">
  <h1>⚡ Bohemian – Keys Mode ⚡</h1>

  <!-- OSC / WT & Pitch -->
  <div class="card">
    <div class="row">
      <div>
        <strong>WT A</strong>
        <select id="wtA">
          <option value="sine">Sine</option>
          <option value="sawtooth" selected>Saw</option>
          <option value="square">Square</option>
          <option value="customA">Custom (A)</option>
        </select>
      </div>
      <div>
        <strong>WT B</strong>
        <select id="wtB">
          <option value="sine">Sine</option>
          <option value="sawtooth">Saw</option>
          <option value="square" selected>Square</option>
          <option value="customB">Custom (B)</option>
        </select>
      </div>
      <label>WT Mix:
        <input id="wtMix" type="range" min="0" max="1" step="0.01" value="0.50">
        <span id="wtMixv" class="num">0.50</span>
      </label>
    </div>

    <div class="row" style="margin-top:10px">
      <label>Base (MIDI):
        <input id="baseMidi" type="range" min="36" max="84" step="1" value="60">
        <span id="baseMidiv" class="num">60</span>
      </label>

      <!-- Serum-style pitch -->
      <label>Oct:
        <input id="oct" type="range" min="-3" max="3" step="1" value="0"> <span id="octv" class="num">0</span>
      </label>
      <label>Semi:
        <input id="semi" type="range" min="-12" max="12" step="1" value="0"> <span id="semiv" class="num">0</span>
      </label>
      <label>Coarse:
        <input id="coarse" type="range" min="-24" max="24" step="1" value="0"> <span id="coarsev" class="num">0</span>
      </label>
      <label>Fine (cents):
        <input id="fine" type="range" min="-50" max="50" step="1" value="0"> <span id="finev" class="num">0</span>
      </label>

      <!-- Amp envelope -->
      <label>Attack:
        <input id="att" type="range" min="0" max="1" step="0.01" value="0.01"> <span id="attv" class="num">0.01</span>
      </label>
      <label>Decay:
        <input id="dec" type="range" min="0" max="2" step="0.01" value="0.10"> <span id="decv" class="num">0.10</span>
      </label>
      <label>Sustain:
        <input id="sus" type="range" min="0" max="1" step="0.01" value="0.8"> <span id="susv" class="num">0.80</span>
      </label>
      <label>Release:
        <input id="rel" type="range" min="0" max="3" step="0.01" value="0.3"> <span id="relv" class="num">0.30</span>
      </label>

      <!-- Filter -->
      <label>Filter:
        <input id="cut" type="range" min="100" max="10000" step="1" value="5000"> <span id="cutv" class="num">5000</span>
      </label>
      <label>Reso:
        <input id="q" type="range" min="0.1" max="20" step="0.1" value="0.8"> <span id="qv" class="num">0.8</span>
      </label>

      <!-- LFO (optional, off default) -->
      <label>LFO → Pitch:
        <input id="lfoDepth" type="range" min="0" max="1" step="0.01" value="0.00"> <span id="lfoDepthv" class="num">0.00</span>
      </label>
      <label>LFO Rate (Hz):
        <input id="lfoRate" type="range" min="0.1" max="20" step="0.1" value="2"> <span id="lfoRatev" class="num">2.0</span>
      </label>
    </div>

    <p class="hint">
      Keyboard: <span class="kbd">Z X C V B N M</span> = C3 row, <span class="kbd">S D G H J</span> = black keys.  
      <span class="kbd">Q W E R T Y U</span> = C4 row, <span class="kbd">2 3 5 6 7</span> = black keys.  
      Audio starts on first key press (no Play button). Press any mapped key to begin.
    </p>
  </div>

  <!-- Custom WT Editor -->
  <div class="card">
    <div class="row">
      <strong>Custom Wavetable (additive partials × 16)</strong>
      <label>Target:
        <select id="customTarget">
          <option value="A">Apply to A</option>
          <option value="B">Apply to B</option>
        </select>
      </label>
      <button id="applyCustom" class="btn ghost">Apply to Target</button>
    </div>
    <div class="sliders" id="partialsWrap"></div>
    <p class="hint">Tip: Partial1=1 gives a sine. Add upper partials for color. Re-apply after tweaking.</p>
  </div>

  <p class="hint">If no sound: click the page once, then press a key (browser autoplay policy).</p>
</div>

<script>
window.addEventListener('load', () => {
  // ===== UI refs
  const wtA = document.getElementById('wtA'), wtB = document.getElementById('wtB');
  const wtMix = document.getElementById('wtMix'), wtMixv = document.getElementById('wtMixv');
  const baseMidi = document.getElementById('baseMidi'), baseMidiv = document.getElementById('baseMidiv');

  const oct=document.getElementById('oct'), octv=document.getElementById('octv');
  const semi=document.getElementById('semi'), semiv=document.getElementById('semiv');
  const coarse=document.getElementById('coarse'), coarsev=document.getElementById('coarsev');
  const fine=document.getElementById('fine'), finev=document.getElementById('finev');

  const att=document.getElementById('att'), attv=document.getElementById('attv');
  const dec=document.getElementById('dec'), decv=document.getElementById('decv');
  const sus=document.getElementById('sus'), susv=document.getElementById('susv');
  const rel=document.getElementById('rel'), relv=document.getElementById('relv');

  const cut=document.getElementById('cut'), cutv=document.getElementById('cutv');
  const q=document.getElementById('q'), qv=document.getElementById('qv');

  const lfoDepth=document.getElementById('lfoDepth'), lfoDepthv=document.getElementById('lfoDepthv');
  const lfoRate=document.getElementById('lfoRate'), lfoRatev=document.getElementById('lfoRatev');

  wtMix.addEventListener('input',()=> wtMixv.textContent=(+wtMix.value).toFixed(2));
  baseMidi.addEventListener('input',()=> baseMidiv.textContent=baseMidi.value);

  [oct,semi,coarse,fine].forEach(x=>x.addEventListener('input',()=>({octv,semiv,coarsev,finev}[x.id+'v'].textContent=x.value)));
  [att,dec,sus,rel].forEach(x=>x.addEventListener('input',()=>({attv,decv,susv,relv}[x.id+'v'].textContent=Number(x.value).toFixed( x.id==='sus'?2:2 )));
  [cut,q].forEach(x=>x.addEventListener('input',()=>({cutv,qv}[x.id+'v'].textContent=Number(x.value).toFixed( x.id==='q'?1:0 ))));
  [lfoDepth,lfoRate].forEach(x=>x.addEventListener('input',()=>({lfoDepthv,lfoRatev}[x.id+'v'].textContent=Number(x.value).toFixed( x.id==='lfoRate'?1:2 ))));

  // ===== Custom WT Editor
  const customTarget = document.getElementById('customTarget');
  const partialsWrap = document.getElementById('partialsWrap');
  const applyCustom = document.getElementById('applyCustom');
  const PARTS=16, partialSliders=[];
  for(let i=1;i<=PARTS;i++){
    const lab=document.createElement('label');
    lab.innerHTML = `P${i}<input type="range" min="0" max="1" step="0.01" value="${i===1?1:0}" style="height:90px;writing-mode:bt-lr;appearance:slider-vertical">`;
    partialsWrap.appendChild(lab);
    partialSliders.push(lab.querySelector('input'));
  }
  function currentCustomPartials(){
    const arr=[0]; for(let i=0;i<PARTS;i++) arr[i+1]=+partialSliders[i].value; return arr;
  }

  // ===== Synth engine (mono, keys-first)
  let started=false;
  let oscA=null, oscB=null, gainEnv=null, amp=null, filter=null, lfo=null;
  const keyToSemi = {
    'z':0,'s':1,'x':2,'d':3,'c':4,'v':5,'g':6,'b':7,'h':8,'n':9,'j':10,'m':11,',':12,
    'q':12,'2':13,'w':14,'3':15,'e':16,'r':17,'5':18,'t':19,'6':20,'y':21,'7':22,'u':23,'i':24
  };
  const held=new Set();
  const midiToFreq = m => 440*Math.pow(2,(m-69)/12);

  function totalDetuneCents(){
    return (+oct.value)*1200 + (+semi.value)*100 + (+coarse.value)*100 + (+fine.value);
  }

  function setWT(osc, which, target){
    if(!osc) return;
    if(which==='sine' || which==='sawtooth' || which==='square'){
      osc.type = which;
    }else if(which==='customA' || which==='customB'){
      const partials = currentCustomPartials();
      osc.set({ type:'custom', partials });
    }
  }

  function rebuild(){
    // dispose old
    [oscA,oscB,gainEnv,amp,filter,lfo].forEach(n=>{ try{ n?.dispose?.(); }catch(_){} });

    // nodes
    filter = new Tone.Filter(+cut.value,'lowpass'); filter.Q.value=+q.value;
    amp    = new Tone.Gain(0).connect(filter).toDestination();
    gainEnv= new Tone.AmplitudeEnvelope({
      attack:+att.value, decay:+dec.value, sustain:+sus.value, release:+rel.value
    }).connect(amp);

    oscA = new Tone.Oscillator(midiToFreq(+baseMidi.value),'sawtooth').connect(gainEnv);
    oscB = new Tone.Oscillator(midiToFreq(+baseMidi.value),'square').connect(gainEnv);
    setWT(oscA, wtA.value, 'A');
    setWT(oscB, wtB.value, 'B');

    oscA.detune.value = totalDetuneCents();
    oscB.detune.value = totalDetuneCents();

    oscA.start(); oscB.start(); // keep running; gate via envelope
    setMix();
    // LFO (optional)
    lfo = new Tone.LFO(+lfoRate.value, -1, 1);
    lfo.connect({
      set value(v){
        const cents = (+lfoDepth.value)*v*1200;
        oscA.detune.value = totalDetuneCents() + cents;
        oscB.detune.value = totalDetuneCents() + cents;
      }
    });
    lfo.start();
  }

  function setMix(){
    const mix = +wtMix.value; // 0..1
    // simple gain balance by setting oscillator volumes
    oscA.volume.value = Tone.gainToDb(1 - mix);
    oscB.volume.value = Tone.gainToDb(mix);
  }

  function noteOn(midi){
    // retrigger envelope, set base freq w/ global detune
    const freq = midiToFreq(midi);
    oscA.frequency.setValueAtTime(freq, Tone.now());
    oscB.frequency.setValueAtTime(freq, Tone.now());
    oscA.detune.value = totalDetuneCents();
    oscB.detune.value = totalDetuneCents();
    gainEnv.triggerAttack();
  }
  function noteOff(){
    gainEnv.triggerRelease();
  }

  function ensureStarted(){
    if(started) return;
    Tone.start().then(()=>{ started=true; rebuild(); }).catch(console.error);
  }

  // UI reactions
  wtA.addEventListener('change',()=> setWT(oscA, wtA.value, 'A'));
  wtB.addEventListener('change',()=> setWT(oscB, wtB.value, 'B'));
  wtMix.addEventListener('input', setMix);

  ;[att,dec,sus,rel].forEach(x=>x.addEventListener('change',()=> rebuild()));
  ;[cut,q].forEach(x=>x.addEventListener('input',()=>{ if(filter){ if(x===cut) filter.frequency.value=+cut.value; else filter.Q.value=+q.value; }}));
  ;[oct,semi,coarse,fine].forEach(x=>x.addEventListener('input',()=>{ if(oscA){ oscA.detune.value=totalDetuneCents(); oscB.detune.value=totalDetuneCents(); }}));
  lfoDepth.addEventListener('input',()=>{}); // handled in LFO receiver
  lfoRate.addEventListener('input',()=>{ lfo?.frequency?.value = +lfoRate.value; });

  // Apply custom partials
  document.getElementById('applyCustom').addEventListener('click',()=>{
    ensureStarted();
    const target = customTarget.value;
    if(target==='A') setWT(oscA, 'customA', 'A');
    else setWT(oscB, 'customB', 'B');
  });

  // Keyboard control
  window.addEventListener('keydown', e=>{
    const k=e.key.toLowerCase();
    if(keyToSemi[k]===undefined) return;
    e.preventDefault();
    ensureStarted();
    const midi = (+baseMidi.value) + keyToSemi[k] - 12; // Z row ~ C3 relative to base
    if(!held.has(midi)){
      held.add(midi);
      noteOn(midi);
    }
  });
  window.addEventListener('keyup', e=>{
    const k=e.key.toLowerCase();
    if(keyToSemi[k]===undefined) return;
    const midi = (+baseMidi.value) + keyToSemi[k] - 12;
    held.delete(midi);
    if(held.size===0) noteOff();
  });

  // init text
  wtMixv.textContent=(+wtMix.value).toFixed(2);
  baseMidiv.textContent=baseMidi.value;
  ;[octv,semiv,coarsev,finev].forEach((el,i)=> el.textContent=['0','0','0','0'][i]);
  ;[attv,decv,susv,relv].forEach((el,i)=> el.textContent=[+att.value,+dec.value,+sus.value,+rel.value][i].toFixed(2));
  cutv.textContent=+cut.value; qv.textContent=(+q.value).toFixed(1);
  lfoDepthv.textContent=(+lfoDepth.value).toFixed(2);
  lfoRatev.textContent=(+lfoRate.value).toFixed(1);
});
</script>
</body>
</html>
