<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bohemian – Audio Debug</title>
<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
<style>
  body{background:#0b0f19;color:#e5e7eb;font-family:system-ui;margin:0;padding:24px}
  .box{max-width:700px;margin:0 auto;background:#111827;border:1px solid #1f2937;border-radius:12px;padding:18px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .kv{background:#0a0f1f;border:1px solid #1f2937;border-radius:10px;padding:10px;min-width:160px}
  button{background:#0a0f1f;border:1px solid #374151;color:#e5e7eb;border-radius:8px;padding:8px 12px;cursor:pointer}
  code{background:#0a0f1f;border:1px solid #1f2937;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
<div class="box">
  <h1>Audio Debug</h1>
  <p>Press any mapped key (Z/X/… or Q/W/…) to ping a note. Or click <button id="start">Start Audio</button> then <button id="beep">Beep</button>.</p>
  <div class="row" style="margin:10px 0 16px">
    <div class="kv">Tone loaded: <span id="tone">-</span></div>
    <div class="kv">Context state: <span id="state">-</span></div>
    <div class="kv">Last freq: <span id="freq">-</span></div>
    <div class="kv">Errors: <span id="err">none</span></div>
  </div>
  <p>Mapped rows: <code>Z X C V B N M , . /</code> (+ black: <code>S D G H J</code>) and <code>Q W E R T Y U I O P [ ]</code> (+ <code>2 3 5 6 7 9 0</code>).</p>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const sTone=$('tone'), sState=$('state'), sFreq=$('freq'), sErr=$('err');
  const btnStart=$('start'), btnBeep=$('beep');

  // 1) show Tone status
  sTone.textContent = (typeof Tone!=='undefined') ? 'yes' : 'NO (Tone.js not loaded)';
  function updateState(){ try{ sState.textContent = Tone.getContext().rawContext.state; }catch{ sState.textContent='(no ctx)'; } }
  updateState();

  // 2) super-minimal synth
  let started=false, synth=null;
  async function ensureAudio(){
    if(started) return;
    await Tone.start();                    // user gesture: keydown/click でOK
    synth = new Tone.Synth({               // 1台だけ、確実に出るチェーン
      oscillator:{ type:'sawtooth' },
      envelope:{ attack:0.005, decay:0.1, sustain:0.0, release:0.1 }
    }).toDestination();
    started=true; updateState();
  }

  // 3) key → freq
  const keyToSemi={
    'z':0,'s':1,'x':2,'d':3,'c':4,'v':5,'g':6,'b':7,'h':8,'n':9,'j':10,'m':11,',':12,'.':13,'/':14,
    'q':12,'2':13,'w':14,'3':15,'e':16,'r':17,'5':18,'t':19,'6':20,'y':21,'7':22,'u':23,'i':24,'9':25,'o':26,'0':27,'p':28,'[':29,']':31
  };
  const midiToFreq = m => 440 * Math.pow(2,(m-69)/12);
  const baseMidi = 60; // C4中心

  async function ping(freq){
    try{
      await ensureAudio();
      sFreq.textContent = freq.toFixed(2)+' Hz';
      synth.triggerAttackRelease(freq, '16n'); // 1/16拍のピン
    }catch(e){
      console.error(e); sErr.textContent = e && (e.message||String(e));
      updateState();
    }
  }

  window.addEventListener('keydown', async (e)=>{
    const k=e.key.toLowerCase(); if(!(k in keyToSemi)) return;
    e.preventDefault();
    const midi = baseMidi + keyToSemi[k] - 12;         // Z列をC3付近に
    const hz = midiToFreq(midi);
    await ping(hz);
  });

  // 4) buttons
  btnStart.addEventListener('click', async ()=>{ try{ await ensureAudio(); }catch(e){ sErr.textContent=e.message||String(e); } });
  btnBeep.addEventListener('click', async ()=>{ await ping(440); });

  // 5) native WebAudio fallback probe (optional)
  // window.webaudioProbe = function(){ const ac=new (window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(); o.type='sine'; o.frequency.value=440; o.connect(ac.destination); ac.resume(); o.start(); setTimeout(()=>o.stop(),200); return 'ok'; };
})();
</script>
</body>
</html>
