<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bohemian</title>
<link rel="icon" href="/favicon.ico">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
  :root { --bg:#050510; --panel:#0f1423; --line:#1f2937; --fg:#e5e7eb; --mut:#94a3b8; --brand:#8b5cf6; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:'Orbitron',sans-serif}
  h1{font-size:28px;margin:0 0 14px;text-align:center;background:linear-gradient(90deg,#8b5cf6,#06b6d4);
     -webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .wrap{max-width:1120px;margin:0 auto;padding:24px}
  .card{background:rgba(15,20,35,.85);border:1px solid var(--line);border-radius:18px;padding:16px 16px 20px;
        box-shadow:0 16px 36px rgba(0,0,0,.45);backdrop-filter:blur(8px);margin-bottom:16px}
  .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:center}
  .col{display:flex;flex-direction:column;gap:8px}
  canvas.wave{display:block;background:#0a0f1f;border:1px solid #1c2233;border-radius:12px;box-shadow:0 0 10px rgba(139,92,246,.28)}
  .cap{font-size:12px;color:var(--mut);text-align:center;margin-top:6px}
  label{font-size:13px;color:#9ca3af;display:flex;gap:8px;align-items:center}
  input[type="range"]{accent-color:var(--brand)}
  select{background:#0a0f1f;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:6px 8px}
  .num{display:inline-block;min-width:44px;text-align:right}
  .sliders{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;margin-top:8px}
  .sliders label{display:flex;flex-direction:column;align-items:center;font-size:10px;color:#94a3b8}
  .kbd{font-family:ui-monospace,monospace;background:#0a0f1f;border:1px solid #1e2637;border-radius:6px;padding:2px 6px}
  .kb{display:flex;gap:2px;justify-content:center;margin-top:8px}
  .key{width:28px;height:110px;background:#fff;border:1px solid #999;border-bottom:3px solid #bbb;border-radius:4px;position:relative}
  .key.black{width:20px;height:70px;background:#111;border-color:#222;border-bottom-color:#000;position:absolute;left:20px;z-index:2;border-radius:4px}
  .kbdwrap{position:relative;width:420px;height:120px;margin:0 auto}
  .on{outline:2px solid #06b6d4;outline-offset:-2px}
  .hint{color:#9aa4bf;font-size:12px;text-align:center}
</style>
<script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
</head>
<body>
<div class="wrap">
  <h1>⚡ Bohemian ⚡</h1>

  <!-- Top: dual wavetable renderers -->
  <div class="card">
    <div class="row" style="align-items:flex-start">
      <div class="col" style="flex:1 1 480px;min-width:300px">
        <div class="row" style="justify-content:space-between">
          <label>WT A
            <select id="wtA">
              <option value="sine">Sine</option>
              <option value="saw">Saw</option>
              <option value="square">Square</option>
              <option value="customA">Custom (A)</option>
            </select>
          </label>
          <label>WT Mix
            <input id="wtMix" type="range" min="0" max="1" step="0.01" value="0.50">
            <span id="wtMixv" class="num">0.50</span>
          </label>
        </div>
        <canvas id="waveA" class="wave" width="520" height="140"></canvas>
        <div class="cap">A waveform</div>
      </div>
      <div class="col" style="flex:1 1 480px;min-width:300px">
        <div class="row" style="justify-content:flex-start">
          <label>WT B
            <select id="wtB">
              <option value="sine">Sine</option>
              <option value="saw">Saw</option>
              <option value="square">Square</option>
              <option value="customB">Custom (B)</option>
            </select>
          </label>
        </div>
        <canvas id="waveB" class="wave" width="520" height="140"></canvas>
        <div class="cap">B waveform</div>
      </div>
    </div>
  </div>

  <!-- Keyboard + pitch & filter -->
  <div class="card">
    <div class="row">
      <label>Base (MIDI)
        <input id="baseMidi" type="range" min="36" max="84" step="1" value="60">
        <span id="baseMidiv" class="num">60</span>
      </label>
      <label>Oct
        <input id="oct" type="range" min="-3" max="3" step="1" value="0">
        <span id="octv" class="num">0</span>
      </label>
      <label>Semi
        <input id="semi" type="range" min="-12" max="12" step="1" value="0">
        <span id="semiv" class="num">0</span>
      </label>
      <label>Coarse
        <input id="coarse" type="range" min="-24" max="24" step="1" value="0">
        <span id="coarsev" class="num">0</span>
      </label>
      <label>Fine (¢)
        <input id="fine" type="range" min="-50" max="50" step="1" value="0">
        <span id="finev" class="num">0</span>
      </label>
      <label>Cutoff
        <input id="cut" type="range" min="100" max="10000" step="1" value="5000">
        <span id="cutv" class="num">5000</span>
      </label>
      <label>Reso
        <input id="q" type="range" min="0.1" max="20" step="0.1" value="0.8">
        <span id="qv" class="num">0.8</span>
      </label>
      <label>Attack
        <input id="att" type="range" min="0" max="1" step="0.01" value="0.01">
        <span id="attv" class="num">0.01</span>
      </label>
      <label>Release
        <input id="rel" type="range" min="0" max="3" step="0.01" value="0.3">
        <span id="relv" class="num">0.30</span>
      </label>
    </div>

    <!-- Visual mini keyboard (2 octaves) -->
    <div class="kbdwrap" id="piano"></div>
    <p class="hint">Computer keys (chromatic): 
      <span class="kbd">Z X C V B N M , . /</span> (+ <span class="kbd">S D G H J</span>) · 
      <span class="kbd">Q W E R T Y U I O P [ ]</span> (+ <span class="kbd">2 3 5 6 7 9 0</span>).  
      Press any mapped key to start audio if silent.</p>
  </div>

  <!-- Custom additive editor -->
  <div class="card">
    <div class="row">
      <strong>Custom Wavetable (16 partials)</strong>
      <label>Target
        <select id="customTarget">
          <option value="A">Apply → A</option>
          <option value="B">Apply → B</option>
        </select>
      </label>
      <button id="applyCustom" class="btn ghost">Apply</button>
    </div>
    <div class="sliders" id="partialsWrap"></div>
    <p class="hint">Tip: P1=1 = sine. Add upper partials for color. Re-apply after changes.</p>
  </div>
</div>

<script>
window.addEventListener('load', () => {
  // ---------- UI refs ----------
  const wtA = document.getElementById('wtA'), wtB = document.getElementById('wtB');
  const wtMix = document.getElementById('wtMix'), wtMixv = document.getElementById('wtMixv');
  const baseMidi = document.getElementById('baseMidi'), baseMidiv = document.getElementById('baseMidiv');
  const oct=document.getElementById('oct'), octv=document.getElementById('octv');
  const semi=document.getElementById('semi'), semiv=document.getElementById('semiv');
  const coarse=document.getElementById('coarse'), coarsev=document.getElementById('coarsev');
  const fine=document.getElementById('fine'), finev=document.getElementById('finev');
  const cut=document.getElementById('cut'), cutv=document.getElementById('cutv');
  const q=document.getElementById('q'), qv=document.getElementById('qv');
  const att=document.getElementById('att'), attv=document.getElementById('attv');
  const rel=document.getElementById('rel'), relv=document.getElementById('relv');
  const waveA=document.getElementById('waveA'), waveB=document.getElementById('waveB');
  const ctxA=waveA.getContext('2d'), ctxB=waveB.getContext('2d');

  wtMix.addEventListener('input',()=> wtMixv.textContent=(+wtMix.value).toFixed(2));
  baseMidi.addEventListener('input',()=> baseMidiv.textContent=baseMidi.value);
  ;[oct,semi,coarse,fine].forEach(x=>x.addEventListener('input',()=>({octv,semiv,coarsev,finev}[x.id+'v'].textContent=x.value)));
  ;[cut,q].forEach(x=>x.addEventListener('input',()=>({cutv,qv}[x.id+'v'].textContent= Number(x.value).toFixed(x.id==='q'?1:0) ));
  att.addEventListener('input',()=> attv.textContent=Number(att.value).toFixed(2));
  rel.addEventListener('input',()=> relv.textContent=Number(rel.value).toFixed(2));

  // ---------- Custom partials ----------
  const customTarget = document.getElementById('customTarget');
  const partialsWrap = document.getElementById('partialsWrap');
  const applyCustom = document.getElementById('applyCustom');
  const PARTS=16, partialSliders=[];
  for(let i=1;i<=PARTS;i++){
    const lab=document.createElement('label');
    lab.innerHTML=`P${i}<input type="range" min="0" max="1" step="0.01" value="${i===1?1:0}"
                    style="height:90px;writing-mode:bt-lr;appearance:slider-vertical">`;
    partialsWrap.appendChild(lab);
    partialSliders.push(lab.querySelector('input'));
  }
  const getPartials = ()=>{ const a=[0]; for(let i=0;i<PARTS;i++) a[i+1]=+partialSliders[i].value; return a; };

  // ---------- Keyboard mapping ----------
  const keyToSemi = {
    // lower row Z..M (white + black)
    'z':0,'s':1,'x':2,'d':3,'c':4,'v':5,'g':6,'b':7,'h':8,'n':9,'j':10,'m':11,',':12,'.':13,'/':14,
    // upper row Q..] (white + black incl numbers)
    'q':12,'2':13,'w':14,'3':15,'e':16,'r':17,'5':18,'t':19,'6':20,'y':21,'7':22,'u':23,'i':24,'9':25,'o':26,'0':27,'p':28,'[':29,']':31
  };
  const held = new Set();
  const midiToFreq = m => 440 * Math.pow(2,(m-69)/12);

  // ---------- Synth engine (mono) ----------
  let started=false;
  let oscA=null, oscB=null, ampEnv=null, amp=null, filter=null;

  function totalDetuneCents(){
    return (+oct.value)*1200 + (+semi.value)*100 + (+coarse.value)*100 + (+fine.value);
  }
  function setWT(osc, which, partialsCache){
    if(!osc) return;
    if(which==='sine'){ osc.type='sine'; }
    else if(which==='saw'){ osc.type='sawtooth'; }
    else if(which==='square'){ osc.type='square'; }
    else if(which==='customA' || which==='customB'){ osc.set({ type:'custom', partials: partialsCache }); }
  }
  let partialsA = getPartials(), partialsB = getPartials(); // defaults

  function rebuild(){
    [oscA,oscB,ampEnv,amp,filter].forEach(n=>{ try{ n?.dispose?.(); }catch{} });

    filter = new Tone.Filter(+cut.value,'lowpass'); filter.Q.value=+q.value;
    amp    = new Tone.Gain(0).connect(filter).toDestination();
    ampEnv = new Tone.AmplitudeEnvelope({attack:+att.value,decay:0.1,sustain:0.9,release:+rel.value}).connect(amp);

    const baseHz = midiToFreq(+baseMidi.value);
    oscA = new Tone.Oscillator(baseHz,'sawtooth').connect(ampEnv);
    oscB = new Tone.Oscillator(baseHz,'square').connect(ampEnv);

    setWT(oscA, wtA.value, partialsA);
    setWT(oscB, wtB.value, partialsB);

    oscA.detune.value = totalDetuneCents();
    oscB.detune.value = totalDetuneCents();

    oscA.start(); oscB.start();
    setMix();
  }

  function setMix(){
    const mix=+wtMix.value;
    oscA.volume.value = Tone.gainToDb(1 - mix);
    oscB.volume.value = Tone.gainToDb(mix);
  }

  function noteOn(midi){
    const hz = midiToFreq(midi);
    oscA.frequency.setValueAtTime(hz, Tone.now());
    oscB.frequency.setValueAtTime(hz, Tone.now());
    oscA.detune.value = totalDetuneCents();
    oscB.detune.value = totalDetuneCents();
    ampEnv.triggerAttack();
  }
  function noteOff(){
    ampEnv.triggerRelease();
  }
  function ensureStarted(){
    if(started) return;
    Tone.start().then(()=>{ started=true; rebuild(); }).catch(console.error);
  }

  // ---------- Waveform renderers ----------
  function drawWave(ctx, type, partials){
    const W=ctx.canvas.width, H=ctx.canvas.height;
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#0a0f1f'; ctx.fillRect(0,0,W,H);
    ctx.strokeStyle='#22304a'; ctx.lineWidth=1;
    // midline
    ctx.beginPath(); ctx.moveTo(0,H/2); ctx.lineTo(W,H/2); ctx.stroke();

    const N=1024; // sample points of one cycle
    const y = new Float32Array(N);
    for(let i=0;i<N;i++){
      const t=i/N; // 0..1 phase
      let v=0;
      if(type==='sine'){ v=Math.sin(2*Math.PI*t); }
      else if(type==='saw'){ v=2*(t-0.5); } // simple linear
      else if(type==='square'){ v=Math.sign(Math.sin(2*Math.PI*t))||1; }
      else { // custom via partials (cosine series amplitudes)
        for(let n=1;n<partials.length;n++){
          const a = partials[n]||0;
          v += a * Math.sin(2*Math.PI*n*t);
        }
        // normalize a bit
        v = Math.max(-1, Math.min(1, v));
      }
      y[i]=v;
    }
    // draw
    ctx.strokeStyle='#8b5cf6'; ctx.lineWidth=2; ctx.beginPath();
    for(let i=0;i<N;i++){
      const px = i/(N-1) * (W-16) + 8;
      const py = H/2 - y[i] * (H*0.4);
      if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.stroke();
  }

  function refreshWaves(){
    const aType = wtA.value==='customA' ? 'custom' : (wtA.value==='saw'?'saw':wtA.value==='square'?'square':'sine');
    const bType = wtB.value==='customB' ? 'custom' : (wtB.value==='saw'?'saw':wtB.value==='square'?'square':'sine');
    drawWave(ctxA, aType, aType==='custom'? partialsA : [0]);
    drawWave(ctxB, bType, bType==='custom'? partialsB : [0]);
  }

  // ---------- Custom apply ----------
  document.getElementById('applyCustom').addEventListener('click',()=>{
    const parts = getPartials();
    if(customTarget.value==='A'){ partialsA = parts; if(oscA) oscA.set({type:'custom',partials:parts}); }
    else { partialsB = parts; if(oscB) oscB.set({type:'custom',partials:parts}); }
    refreshWaves();
  });

  // ---------- Piano UI ----------
  // Build simple 2-octave piano (C3..B4)
  const piano = document.getElementById('piano');
  const whiteOrder=[0,2,4,5,7,9,11,12,14,16,17,19,21,23]; // semis from base
  const blackPos={1:18,3:46,6:102,8:130,10:158,13:214,15:242,18:298,20:326,22:354}; // px offsets approx
  piano.style.position='relative';
  // whites
  for(let i=0;i<whiteOrder.length;i++){
    const k=document.createElement('div'); k.className='key'; k.style.position='relative';
    k.style.left=(i*30)+'px'; k.dataset.semi=whiteOrder[i];
    piano.appendChild(k);
  }
  // blacks
  Object.entries(blackPos).forEach(([semi,left])=>{
    const k=document.createElement('div'); k.className='key black'; k.style.left=left+'px'; k.dataset.semi=semi;
    piano.appendChild(k);
  });
  function pressUI(semi,on){
    const el=[...piano.querySelectorAll('[data-semi="'+semi+'"]')][0];
    if(!el) return;
    if(on) el.classList.add('on'); else el.classList.remove('on');
  }
  piano.addEventListener('mousedown',e=>{
    const t=e.target.closest('[data-semi]'); if(!t){return;}
    ensureStarted();
    const semi=+t.dataset.semi;
    const midi = (+baseMidi.value) + semi - 12; // align with Z row logic
    pressUI(semi,true); noteOn(midi);
  });
  window.addEventListener('mouseup',()=>{ noteOff(); [...piano.querySelectorAll('.on')].forEach(el=>el.classList.remove('on')); });

  // ---------- Events ----------
  wtA.addEventListener('change',()=>{ if(oscA){ setWT(oscA, wtA.value, partialsA); } refreshWaves(); });
  wtB.addEventListener('change',()=>{ if(oscB){ setWT(oscB, wtB.value, partialsB); } refreshWaves(); });
  wtMix.addEventListener('input',()=> setMix());
  ;[oct,semi,coarse,fine].forEach(x=>x.addEventListener('input',()=>{ if(oscA){ oscA.detune.value=totalDetuneCents(); oscB.detune.value=totalDetuneCents(); }}));
  ;[cut,q].forEach(x=>x.addEventListener('input',()=>{ if(filter){ filter.frequency.value=+cut.value; filter.Q.value=+q.value; }}));
  ;[att,rel].forEach(x=>x.addEventListener('change',()=>{ if(ampEnv){ ampEnv.set({attack:+att.value,release:+rel.value}); }}));

  // Computer keyboard → notes
  function ensureAudioKey(){ if(!started){ ensureStarted(); } }
  window.addEventListener('keydown', e=>{
    const k=e.key.toLowerCase();
    if(!(k in keyToSemi)) return;
    e.preventDefault();
    ensureAudioKey();
    const midi = (+baseMidi.value) + keyToSemi[k] - 12; // lower row centered
    if(!held.has(midi)){ held.add(midi); noteOn(midi); }
  });
  window.addEventListener('keyup', e=>{
    const k=e.key.toLowerCase();
    if(!(k in keyToSemi)) return;
    const midi = (+baseMidi.value) + keyToSemi[k] - 12;
    held.delete(midi);
    if(held.size===0) noteOff();
  });

  // init text & waves
  wtMixv.textContent=(+wtMix.value).toFixed(2);
  baseMidiv.textContent=baseMidi.value;
  ;[octv,semiv,coarsev,finev].forEach((el,i)=> el.textContent=['0','0','0','0'][i]);
  attv.textContent=Number(att.value).toFixed(2);
  relv.textContent=Number(rel.value).toFixed(2);
  cutv.textContent=+cut.value; qv.textContent=(+q.value).toFixed(1);
  refreshWaves();
});
</script>
</body>
</html>
